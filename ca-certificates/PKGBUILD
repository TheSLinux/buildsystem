#!/bin/bash

# Maintainer: Anh K. Huynh <kyanh@theslinux.org>
# Original Maintainer: Pierre Schmitz <pierre@archlinux.de>

pkgdesc='Common CA certificates'
arch=('any')
url='http://packages.qa.debian.org/c/ca-certificates.html'
license=('MPL' 'GPL')

source=("remove-run-parts.patch")

vercmp "${PACKAGE_VERSION}" "2014.03.25" >/dev/null
if [[ $? -ge 0 ]]; then
  source+=("http://ftp.debian.org/debian/pool/main/c/${pkgbase}/${pkgbase}_${pkgver//.}.tar.xz")
else
  source+=("http://ftp.debian.org/debian/pool/main/c/${pkgbase}/${pkgbase}_${pkgver//.}.tar.gz")
fi

depends=('bash' 'openssl' 'findutils' 'coreutils' 'sed')
makedepends=('python2')
install='ca-certificates.install'
backup=('etc/ca-certificates.conf')

# FIXME: For some reason, the base directory in 2013.09.06 version
# FIXME: is `certificate`, not `certificate-20130906`. This is from
# FIXME: Debian repository, and may need more persitent way.
vercmp "${PACKAGE_VERSION}" "2013.09.06" >/dev/null
if [[ $? -ge 0 ]]; then
  _srcdir_fixed="${pkgbase}"
else
  _srcdir_fixed="${pkbase}-${pkgver//.}"
fi

build() {
  cd "${_srcdir_fixed}"
  sed 's|/usr/bin/python|/usr/bin/python2|g' -i mozilla/certdata2pem.py
  sed 's|python|python2|g' -i mozilla/Makefile
  patch -Np4 < "${srcdir}/remove-run-parts.patch"
  make
}

package() {
  cd "${_srcdir_fixed}"
  install -d -m755 ${pkgdir}/{etc/ca-certificates/update.d,usr/{sbin,share/ca-certificates},etc/ssl/certs}
  make install DESTDIR=${pkgdir}
  install -D -m644 sbin/update-ca-certificates.8 ${pkgdir}/usr/share/man/man8/update-ca-certificates.8

  (
  echo "# Automatically generated by ${pkgbase}-${pkgver}-${pkgrel}"
  echo "# see update-ca-certificates man page"
  echo "# "
  cd ${pkgdir}/usr/share/ca-certificates
  find . -name '*.crt' | sort | cut -b3-
  ) > ${pkgdir}/etc/ca-certificates.conf
}
